name: Auto Release

on:
  workflow_run:
    workflows: ["Create Release ZIP"]
    types:
      - completed
    branches:
      - main

jobs:
  create-release:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Resolve version and artifact metadata
        id: meta
        run: |
          VERSION=$(node -p "require('./app-v3/package.json').version")
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=v$VERSION" >> "$GITHUB_OUTPUT"
          echo "artifact_name=upwork-job-scraper-v$VERSION-chrome" >> "$GITHUB_OUTPUT"

      - name: Download zip artifact from workflow run
        uses: actions/download-artifact@v5
        with:
          name: ${{ steps.meta.outputs.artifact_name }}
          path: release-artifacts
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Locate zip file
        id: zip
        run: |
          ZIP_FILE=$(find release-artifacts -name "*.zip" | head -n 1)
          if [[ -z "$ZIP_FILE" ]]; then
            echo "No zip file found in downloaded artifact"
            exit 1
          fi
          echo "zip_file=$ZIP_FILE" >> "$GITHUB_OUTPUT"

      - name: Create or update release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ steps.meta.outputs.tag }}"
          VERSION="${{ steps.meta.outputs.version }}"
          ZIP_FILE="${{ steps.zip.outputs.zip_file }}"

          if gh release view "$TAG" >/dev/null 2>&1; then
            gh release upload "$TAG" "$ZIP_FILE" --clobber
          else
            gh release create "$TAG" \
              "$ZIP_FILE" \
              --title "Upwork Job Scraper v$VERSION" \
              --generate-notes \
              --target "${{ github.event.workflow_run.head_sha }}"
          fi
